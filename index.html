<script>
document.addEventListener("DOMContentLoaded", ()=>{

  const form = document.getElementById("addForm");
  const btnGeo = document.getElementById("btnGeo");
  const btnSubmit = document.getElementById("btnSubmit");

  const nome = document.getElementById("nome");
  const regional = document.getElementById("regional");
  const polo = document.getElementById("polo");
  const matricula = document.getElementById("matricula");
  const datauso = document.getElementById("datauso");
  const tiporefeicao = document.getElementById("tiporefeicao");
  const horario = document.getElementById("horario");
  const localidade = document.getElementById("localidade");
  const geo = document.getElementById("geo");
  const sequencia = document.getElementById("sequencia");
  const osrrss = document.getElementById("osrrss");
  const numeroadd = document.getElementById("numeroadd");
  const observacao = document.getElementById("observacao");

  /* GEOLOCATION */
  btnGeo.addEventListener("click", ()=>{
    if(!navigator.geolocation){ alert("Geolocalização não suportada."); return; }
    btnGeo.innerText="Capturando...";
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      geo.value = `${lat}, ${lng}`;
      btnGeo.innerText="Localização OK!";
      btnGeo.style.background="#43a047";
    },(err)=>{
      console.error("geolocation error:", err);
      alert("Ative o GPS e tente novamente.");
      btnGeo.innerText="Obter Localização";
    },{enableHighAccuracy:true,timeout:10000});
  });

  /* Gera CSV simples (mesma função sua) */
  function gerarCSV(obj){
    const headers = Object.keys(obj);
    const values  = Object.values(obj);
    const q = v=>`"${String(v??"").replace(/"/g,'""')}"`;
    return headers.map(q).join(",") + "\n" + values.map(q).join(",");
  }

  /* SUBMIT - usa FormData (envia arquivo real) e logs detalhados */
  form.addEventListener("submit", async e=>{
    e.preventDefault();
    btnSubmit.disabled=true;
    btnSubmit.innerText="Processando...";

    try{
      // --- cria payload
      const payload = {
        nome: nome.value.trim(),
        regional: regional.value,
        polo: polo.value,
        matricula: matricula.value.trim(),
        datauso: datauso.value,
        tiporefeicao: tiporefeicao.value,
        horario: horario.value,
        localidade: localidade.value.trim(),
        gps: geo.value,
        sequencia: sequencia.value.trim(),
        osrrss: osrrss.value.trim(),
        numeroadd: numeroadd.value.trim(),
        observacao: observacao.value.trim()
      };

      // --- gera csv (texto)
      const csv = gerarCSV(payload);
      const csvFilename = `ADD_${payload.nome.replace(/\s+/g,"_") || "anonimo"}_${(new Date()).toISOString().slice(0,10)}.csv`;
      const csvBlob = new Blob([csv], { type: "text/csv" });

      // --- monta FormData para enviar ao Worker (melhor: evita base64 no cliente)
      const fd = new FormData();
      // campos individuais (facilita debug no Worker)
      Object.entries(payload).forEach(([k,v]) => fd.append(k, v ?? ""));
      // anexa o arquivo real
      fd.append("arquivo", new File([csvBlob], csvFilename, { type: "text/csv" }));

      // --- opcional: inspeciona FormData (DEBUG) - não funciona em todos navegadores para ler file contents
      console.log("FormData entries (nome, matricula, ...):");
      for (const pair of fd.entries()) {
        if (pair[1] instanceof File) {
          console.log(pair[0], "(file):", pair[1].name, pair[1].size, pair[1].type);
        } else {
          console.log(pair[0], ":", pair[1]);
        }
      }

      // --- faça a chamada ao Worker (sua URL)
      const workerUrl = "https://long-hall-0aaa.pedro-fillype.workers.dev"; // sua URL
      const resp = await fetch(workerUrl, {
        method: "POST",
        body: fd // Content-Type automaticamente multipart/form-data
      });

      // lê resposta bruta (texto) para depurar
      const text = await resp.text();
      let parsed;
      try { parsed = JSON.parse(text); } catch(e){ parsed = null; }

      console.log("Worker response status:", resp.status);
      console.log("Worker response body:", parsed ?? text);

      if (!resp.ok) {
        // mostra erro detalhado para o usuário e console
        alert("Erro no servidor: " + (parsed?.error || parsed?.message || text || resp.status));
        btnSubmit.disabled=false;
        btnSubmit.innerText="Enviar (E-mail + CSV)";
        return;
      }

      // sucesso
      alert("Enviado com sucesso! Verifique seu e-mail.");
      form.reset();
      btnGeo.innerText="Obter Localização";
      btnGeo.style.background="#1e88e5";

    } catch (err) {
      console.error("Erro no submit:", err);
      // mostra mensagem com detalhe para ajudar debugging
      alert("Erro inesperado. Veja console (F12) para detalhes: " + (err && err.message ? err.message : err));
    } finally {
      btnSubmit.disabled=false;
      btnSubmit.innerText="Enviar (E-mail + CSV)";
    }
  });

});
</script>
