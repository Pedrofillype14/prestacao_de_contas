<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Presta√ß√£o de Contas - ADD</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root {
    --energisa-blue: #0097CE;
    --energisa-blue-dark: #0079a6;
    --energisa-orange: #F36F21;
    --bg-soft: #eef6fa;
    --bg-white: #ffffff;
    --text-dark: #333;
  }

  * { box-sizing: border-box; }
  body {
    font-family: "Segoe UI", Roboto, sans-serif;
    background: var(--bg-soft);
    margin: 0;
  }

  /* HEADER */
  .header {
    background: var(--energisa-blue);
    color: white;
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .header h2 { margin: 0; font-weight: 700; letter-spacing: 1px; }

  .logout-btn {
    background: var(--energisa-orange);
    border: none;
    padding: 10px 14px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: 600;
  }
  .logout-btn:hover { background: #d65c18; }

  /* CARD */
  .card {
    max-width: 900px;
    margin: 30px auto;
    padding: 28px;
    background: var(--bg-white);
    border-radius: 14px;
    box-shadow: 0 6px 26px rgba(0,0,0,0.10);
    border-top: 6px solid var(--energisa-orange);
  }

  h1 {
    text-align: center;
    color: var(--energisa-blue-dark);
    margin-bottom: 20px;
    font-size: 26px;
    font-weight: 800;
  }

  form { display: grid; gap: 15px; }
  label { font-weight: 600; margin-bottom: 4px; }

  input, select, textarea {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #cfd8dc;
    font-size: 15px;
    background: #fdfdfd;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--energisa-blue);
    box-shadow: 0 0 0 2px rgba(0,151,206,0.25);
  }

  /* GRID */
  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
  }
  @media(max-width: 720px) { .row { grid-template-columns: 1fr; } }

  /* BUTTONS */
  button {
    background: var(--energisa-blue);
    color: white;
    border: none;
    padding: 14px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 10px;
    cursor: pointer;
  }
  button:hover { background: var(--energisa-blue-dark); }

  .small { padding: 10px; font-size: 13px; background: var(--energisa-orange); }
  .small:hover { background: #d85e1c; }

  /* LINK DASHBOARD */
  .dashboard-btn {
    display: block;
    background: var(--energisa-blue-dark);
    color: white;
    text-align: center;
    padding: 13px;
    margin-top: 14px;
    border-radius: 10px;
    font-weight: 700;
    text-decoration: none;
  }
  .dashboard-btn:hover { background: #005f85; }

  .muted {
    color: #666;
    font-size: 13px;
    text-align: center;
    margin-top: 10px;
  }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <h2><i class="bi bi-file-earmark-text"></i> Presta√ß√£o de Contas - ADD</h2>
  <button class="logout-btn" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Sair</button>
</div>

<div class="card">
  <h1>FORMUL√ÅRIO</h1>

  <form id="addForm" autocomplete="off">
    <div class="row">
      <div>
        <label>Nome *</label>
        <input id="nome" required>
      </div>
      <div>
        <label>Email *</label>
        <input id="email" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Regional *</label>
        <select id="regional" required>
          <option value="">Selecione...</option>
          <option>LESTE</option><option>CENTRO</option><option>OESTE</option>
        </select>
      </div>

      <div>
        <label>Polo *</label>
        <select id="polo" required>
          <option value="">Selecione...</option>
          <option>Jo√£o Pessoa</option>
          <option>Itabaiana</option>
          <option>Mamanguape</option>
          <option>Borborema</option>
          <option>Campina Grande</option>
          <option>Monteiro</option>
          <option>Guarabira</option>
          <option>Esperan√ßa</option>
          <option>Itaporanga</option>
          <option>Sousa</option>
          <option>Patos</option>
          <option>Catol√© do Rocha</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Matr√≠cula *</label>
        <input id="matricula" required>
      </div>
      <div>
        <label>Data de Uso *</label>
        <input type="date" id="datauso" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Tipo de Refei√ß√£o *</label>
        <select id="tiporefeicao" required>
          <option value="">Selecione...</option>
          <option>ALMO√áO</option>
          <option>JANTA</option>
          <option>EXTRA</option>
        </select>
      </div>
      <div>
        <label>Hor√°rio *</label>
        <input type="time" id="horario" required>
      </div>
    </div>

    <div>
      <label>Localidade *</label>
      <input id="localidade" required>
    </div>

    <div class="row">
      <div>
        <label>Solicitar Localiza√ß√£o (opcional)</label>
        <button type="button" id="btnGeo" class="small">Obter Localiza√ß√£o</button>
      </div>
      <div>
        <label>Coordenadas</label>
        <input id="geo" readonly>
      </div>
    </div>

    <div>
      <label>Sequ√™ncia do ADD (opcional)</label>
      <input id="sequencia">
    </div>

    <div class="row">
      <div>
        <label>N¬∫ OS / RR / SS</label>
        <input id="osrrss">
      </div>
      <div>
        <label>N√∫mero do ADD</label>
        <input id="numeroadd">
      </div>
    </div>

    <div>
      <label>Observa√ß√£o</label>
      <textarea rows="3" id="observacao"></textarea>
    </div>

    <button id="btnSubmit">Enviar Registro</button>

    <a class="dashboard-btn" href="https://pedrofillype14.github.io/prestacao_dashboard/">
      <i class="bi bi-search"></i> Acessar Dashboard
    </a>

    <p class="muted">Desenvolvido por Pedro Fillype ‚Äì Grupo Energisa</p>
  </form>
</div>

<script>

/* üîπ LOGOUT */
function logout(){
  localStorage.clear();
  window.location.href = "https://pedrofillype14.github.io/login/";
}

/* üîπ INICIALIZA√á√ÉO */
document.addEventListener("DOMContentLoaded", async () => {

  // --- VALIDA LOGIN ---
  const matriculaSalva = localStorage.getItem("matricula");

  if (!matriculaSalva) {
    alert("Matr√≠cula n√£o encontrada. Fa√ßa login novamente.");
    window.location.href = "https://pedrofillype14.github.io/login/";
    return;
  }

  // CAMPOS
  const nome = document.getElementById("nome");
  const email = document.getElementById("email");
  const matricula = document.getElementById("matricula");

  matricula.value = matriculaSalva;
  matricula.readOnly = true;
  matricula.style.background = "#e9ecef";

  // --- BUSCA NO WORKER ---
  try {
    const resp = await fetch(`https://long-hall-0aaa.pedro-fillype.workers.dev/colaborador?matricula=${matriculaSalva}`);
    const json = await resp.json();

    if (json.ok && json.dados) {
      nome.value = json.dados.nome;
      email.value = json.dados.email;

      nome.readOnly = true;
      email.readOnly = true;

      nome.style.background = "#e9ecef";
      email.style.background = "#e9ecef";
    }
  } catch (err) {
    console.error("Erro ao buscar dados:", err);
  }
});

/* üîπ GEOLOCALIZA√á√ÉO */
document.getElementById("btnGeo").addEventListener("click", () => {
  const btnGeo = document.getElementById("btnGeo");
  const geo = document.getElementById("geo");

  if (!navigator.geolocation) {
    alert("Seu navegador n√£o suporta geolocaliza√ß√£o.");
    return;
  }

  btnGeo.innerText = "Capturando...";

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      geo.value = `${lat}, ${lng}`;
      btnGeo.innerText = "Localiza√ß√£o OK!";
      btnGeo.style.background = "#43a047";
    },
    () => {
      alert("N√£o foi poss√≠vel capturar a localiza√ß√£o.");
      btnGeo.innerText = "Obter Localiza√ß√£o";
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
});

/* üîπ ENVIO DO FORMUL√ÅRIO */
document.getElementById("addForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const btn = document.getElementById("btnSubmit");
  btn.disabled = true;
  btn.innerText = "Enviando...";

  const get = id => document.getElementById(id).value.trim();

  const payload = {
    nome: get("nome"),
    email: get("email"),
    regional: get("regional"),
    polo: get("polo"),
    matricula: get("matricula"),
    datauso: get("datauso"),
    tiporefeicao: get("tiporefeicao"),
    horario: get("horario"),
    localidade: get("localidade"),
    gps: get("geo"),
    sequencia: get("sequencia"),
    osrrss: get("osrrss"),
    numeroadd: get("numeroadd"),
    observacao: get("observacao")
  };

  try {
    const fd = new FormData();
    for (const [k, v] of Object.entries(payload)) fd.append(k, v);

    const resp = await fetch("https://long-hall-0aaa.pedro-fillype.workers.dev/submit", {
      method: "POST",
      body: fd
    });

    if (!resp.ok) throw new Error("Erro no servidor");
    
    alert("Registro enviado com sucesso!");
    document.getElementById("addForm").reset();
  } 
  catch (err) {
    alert("Erro: " + err.message);
  }

  btn.disabled = false;
  btn.innerText = "Enviar Registro";
});
</script>

</body>
</html>
