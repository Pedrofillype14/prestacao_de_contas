<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Presta√ß√£o de Contas - ADD</title>

<!-- √çCONES -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root {
    --energisa-blue: #0097CE;
    --energisa-blue-dark: #0079a6;
    --energisa-orange: #F36F21;
    --bg-soft: #eef6fa;
    --bg-white: #ffffff;
    --text-dark: #333;
  }

  * { box-sizing: border-box; }

  body {
    font-family: "Segoe UI", Roboto, sans-serif;
    background: var(--bg-soft);
    margin: 0;
    padding: 0;
  }

  /* HEADER */
  .header {
    background: var(--energisa-blue);
    color: white;
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .header h2 {
    margin: 0;
    font-weight: 700;
    letter-spacing: 1px;
  }

  .logout-btn {
    background: var(--energisa-orange);
    border: none;
    padding: 10px 14px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: 600;
  }
  .logout-btn:hover {
    background: #d65c18;
  }

  /* CARD */
  .card {
    max-width: 900px;
    margin: 30px auto;
    padding: 28px;
    background: var(--bg-white);
    border-radius: 14px;
    box-shadow: 0 6px 26px rgba(0,0,0,0.10);
    border-top: 6px solid var(--energisa-orange);
  }

  h1 {
    text-align: center;
    color: var(--energisa-blue-dark);
    margin-bottom: 20px;
    font-size: 26px;
    font-weight: 800;
  }

  form { display: grid; gap: 15px; }

  label { font-weight: 600; margin-bottom: 4px; }

  input, select, textarea {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #cfd8dc;
    font-size: 15px;
    background: #fdfdfd;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--energisa-blue);
    box-shadow: 0 0 0 2px rgba(0,151,206,0.25);
  }

  /* GRID */
  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
  }

  @media(max-width: 720px) {
    .row { grid-template-columns: 1fr; }
  }

  /* BOT√ïES */
  button {
    background: var(--energisa-blue);
    color: white;
    border: none;
    padding: 14px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 10px;
    cursor: pointer;
  }
  button:hover { background: var(--energisa-blue-dark); }

  .small {
    padding: 10px;
    font-size: 13px;
    background: var(--energisa-orange);
  }

  .small:hover { background: #d85e1c; }

  /* LINK DASHBOARD */
  .dashboard-btn {
    display: block;
    background: var(--energisa-blue-dark);
    color: white;
    text-align: center;
    padding: 13px;
    margin-top: 14px;
    border-radius: 10px;
    font-weight: 700;
    text-decoration: none;
  }

  .dashboard-btn:hover {
    background: #005f85;
  }

  .muted {
    color: #666;
    font-size: 13px;
    text-align: center;
    margin-top: 10px;
  }
</style>
</head>
<body>

<!-- üîπ HEADER PADR√ÉO ENERGISA -->
<div class="header">
  <h2><i class="bi bi-file-earmark-text"></i> Presta√ß√£o de Contas - ADD</h2>

  <button class="logout-btn" onclick="logout()">
    <i class="bi bi-box-arrow-right"></i> Sair
  </button>
</div>

<div class="card">
  <h1>FORMUL√ÅRIO</h1>

  <form id="addForm" autocomplete="off">

    <div class="row">
      <div>
        <label>Nome *</label>
        <input id="nome" required>
      </div>

      <div>
        <label>Email *</label>
        <input id="email" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Regional *</label>
        <select id="regional" required>
          <option value="">Selecione...</option>
          <option>LESTE</option><option>CENTRO</option><option>OESTE</option>
        </select>
      </div>

      <div>
        <label>Polo *</label>
        <select id="polo" required>
          <option value="">Selecione...</option>
          <option>Jo√£o Pessoa</option><option>Mamanguape</option>
          <option>Borborema</option><option>Campina Grande</option>
          <option>Monteiro</option><option>Guarabira</option>
          <option>Sousa</option><option>Patos</option>
          <option>Catol√© do Rocha</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Matr√≠cula *</label>
        <input id="matricula" required>
      </div>

      <div>
        <label>Data de Uso *</label>
        <input type="date" id="datauso" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Tipo de Refei√ß√£o *</label>
        <select id="tiporefeicao" required>
          <option value="">Selecione...</option>
          <option>ALMO√áO</option>
          <option>JANTA</option>
          <option>EXTRA</option>
        </select>
      </div>

      <div>
        <label>Hor√°rio *</label>
        <input type="time" id="horario" required>
      </div>
    </div>

    <div>
      <label>Localidade *</label>
      <input id="localidade" required>
    </div>

    <div class="row">
      <div>
        <label>Solicitar Localiza√ß√£o (opcional)</label>
        <button type="button" id="btnGeo" class="small">Obter Localiza√ß√£o</button>
      </div>

      <div>
        <label>Coordenadas</label>
        <input id="geo" readonly>
      </div>
    </div>

    <div>
      <label>Sequ√™ncia do ADD (opcional)</label>
      <input id="sequencia">
    </div>

    <div class="row">
      <div>
        <label>N¬∫ OS / RR / SS</label>
        <input id="osrrss">
      </div>

      <div>
        <label>N√∫mero do ADD</label>
        <input id="numeroadd">
      </div>
    </div>

    <div>
      <label>Observa√ß√£o</label>
      <textarea rows="3" id="observacao"></textarea>
    </div>

    <button id="btnSubmit">Enviar Registro</button>

    <!-- Link Dashboard -->
    <a class="dashboard-btn" href="https://pedrofillype14.github.io/prestacao_dashboard/">
      <i class="bi bi-search"></i> Acessar Dashboard
    </a>

    <p class="muted">Desenvolvido por Pedro Fillype ‚Äì Grupo Energisa</p>
  </form>
</div>


<script>
/* üî¥ LOGOUT */
function logout(){
  localStorage.clear();
  window.location.href = "https://pedrofillype14.github.io/login/";
}

<script>
// üîí BLOQUEIO: s√≥ acessa se estiver logado
document.addEventListener("DOMContentLoaded", async () => {
    const userLogado = localStorage.getItem("usuarioLogado");
    const matricula = localStorage.getItem("matricula");

    if (!userLogado || !matricula) {
        window.location.href = "https://pedrofillype14.github.io/login/";
        return;
    }

    // üîÑ Preencher automaticamente os dados
    preencherDadosUsuario(matricula);
});

/* ============================================================
   üîµ FUN√á√ÉO PARA BUSCAR DADOS DO COLABORADOR NO WORKER
   E PREENCHER O FORMUL√ÅRIO AUTOMATICAMENTE
============================================================ */
async function preencherDadosUsuario(matricula) {
    try {
        const resp = await fetch(
            `https://long-hall-0aaa.pedro-fillype.workers.dev/usuario?matricula=${matricula}`
        );

        const dados = await resp.json();

        if (!dados.ok || !dados.user) return;

        const u = dados.user;

        // Preenche automaticamente
        document.getElementById("nome").value = u.nome;
        document.getElementById("email").value = u.email;
        document.getElementById("matricula").value = u.matricula;
        document.getElementById("regional").value = u.regional || "";
        document.getElementById("polo").value = u.polo || "";

        // ‚ùå Bloqueia para impedir altera√ß√£o
        document.getElementById("nome").disabled = true;
        document.getElementById("email").disabled = true;
        document.getElementById("matricula").disabled = true;
        document.getElementById("regional").disabled = true;
        document.getElementById("polo").disabled = true;

    } catch (err) {
        console.error("Erro ao buscar dados:", err);
    }
}

/* ============================================================
   üìç GEOLOCALIZA√á√ÉO
============================================================ */
document.getElementById("btnGeo").addEventListener("click", () => {
    const output = document.getElementById("geo");

    if (!navigator.geolocation) {
        output.value = "Geolocaliza√ß√£o n√£o suportada";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude.toFixed(6);
            const lon = pos.coords.longitude.toFixed(6);
            output.value = `${lat}, ${lon}`;
        },
        () => { output.value = "Erro ao obter localiza√ß√£o"; }
    );
});

/* ============================================================
   üì§ ENVIO DO FORMUL√ÅRIO
============================================================ */
document.getElementById("addForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const dados = {
        nome: document.getElementById("nome").value,
        email: document.getElementById("email").value,
        regional: document.getElementById("regional").value,
        polo: document.getElementById("polo").value,
        matricula: document.getElementById("matricula").value,
        datauso: document.getElementById("datauso").value,
        tiporefeicao: document.getElementById("tiporefeicao").value,
        horario: document.getElementById("horario").value,
        localidade: document.getElementById("localidade").value,
        gps: document.getElementById("geo").value,
        sequencia: document.getElementById("sequencia").value,
        osrrss: document.getElementById("osrrss").value,
        numeroadd: document.getElementById("numeroadd").value,
        observacao: document.getElementById("observacao").value
    };

    const btn = document.getElementById("btnSubmit");
    btn.innerText = "Enviando...";
    btn.disabled = true;

    try {
        const resp = await fetch("https://long-hall-0aaa.pedro-fillype.workers.dev/add-registro", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados)
        });

        const result = await resp.json();

        if (result.ok) {
            alert("Registro enviado com sucesso!");
            document.getElementById("addForm").reset();
        } else {
            alert("Erro ao enviar!");
        }
    } catch (error) {
        alert("Erro de comunica√ß√£o.");
    }

    btn.innerText = "Enviar Registro";
    btn.disabled = false;
});
</script>

</body>
</html>
