<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Presta√ß√£o de Contas - ADD</title>
<style>
  body{font-family: "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg,#e3f2fd,#fff); padding:24px; color:#333;}
  .card{max-width:900px;margin:18px auto;padding:20px;border-radius:12px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
  h1{text-align:center;color:#0d47a1;margin:6px 0 12px;font-size:20px;text-transform:uppercase;}
  form{display:grid;gap:10px;}
  label{font-weight:600;font-size:14px;}
  input,select,textarea,button{width:100%;padding:12px;border-radius:8px;border:1px solid #cfd8dc;background:#f7f9fc;font-size:15px}
  button{background:#1e88e5;color:#fff;border:none;cursor:pointer;font-weight:700}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  @media(max-width:720px){.row{grid-template-columns:1fr}}
  .small{padding:8px;font-size:13px}
  .muted{color:#666;font-size:13px;text-align:center}
  .row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;              /* antes era 10px ‚Äî reduz o espa√ßo */
  margin-bottom: -4px;   /* remove espa√ßo vertical entre blocos */
}

@media (max-width: 720px) {
  .row {
    grid-template-columns: 1fr;
    gap: 6px;
    margin-bottom: 0;
  }
}
</style>
</head>
<body>
  <div class="card">
    <div style="text-align:center">
      <img src="https://upload.wikimedia.org/wikipedia/commons/f/f6/Logo_energisa.png" alt="Energisa" style="max-width:180px;margin-bottom:6px">
      <h1>PRESTA√á√ÉO DE CONTAS - ADD</h1>
    </div>

    <form id="addForm">
      <label>Nome *</label>
      <input id="nome" type="text" required>

      <label>Regional *</label>
      <select id="regional" required>
        <option value="">Selecione...</option><option>LESTE</option><option>CENTRO</option><option>OESTE</option>
      </select>

      <label>Polo *</label>
      <select id="polo" required>
        <option value="">Selecione...</option>
        <option>Jo√£o Pessoa</option><option>Itabaiana</option><option>Mamanguape</option><option>Borborema</option>
        <option>Campina Grande</option><option>Monteiro</option><option>Guarabira</option><option>Esperan√ßa</option>
        <option>Itaporanga</option><option>Sousa</option><option>Patos</option><option>Catol√© do Rocha</option>
      </select>

      <div class="row">
        <div>
          <label>Matr√≠cula *</label>
          <input id="matricula" type="text" required>
        </div>
        <div>
          <label>Data do uso *</label>
          <input id="datauso" type="date" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Tipo de Refei√ß√£o *</label>
          <select id="tiporefeicao" required>
            <option value="">Selecione...</option>
            <option>ALMO√áO</option><option>JANTA</option><option>EXTRA (AP√ìS DUAS HORAS DO FINAL DA ESCALA) EXCE√á√ÉO</option>
          </select>
        </div>
        <div>
          <label>Hor√°rio *</label>
          <input id="horario" type="time" required>
        </div>
      </div>

      <label>Localidade em que foi usado o ADD *</label>
      <input id="localidade" type="text" required>

      <div class="row">
        <div>
          <label>Solicitar localiza√ß√£o geogr√°fica *</label>
          <button type="button" id="btnGeo" class="small">Obter Localiza√ß√£o</button>
        </div>
        <div>
          <label>Coordenadas *</label>
          <input id="geo" type="text" placeholder="lat, lng" readonly required>
        </div>
      </div>

      <label>Sequ√™ncia do ADD (opcional)</label>
      <input id="sequencia" type="text" placeholder="Ex: 1¬∞, 2¬∞, 3¬∞">

      <div class="row">
        <div>
          <label>N√∫mero da OS / RR / SS (opcional)</label>
          <input id="osrrss" type="text">
        </div>
        <div>
          <label>N√∫mero do ADD (opcional)</label>
          <input id="numeroadd" type="text">
        </div>
      </div>

      <label>Observa√ß√£o sobre a refei√ß√£o (opcional)</label>
      <textarea id="observacao" rows="3"></textarea>

      <button id="btnSubmit" type="submit">Enviar (E-mail + CSV)</button>
      <p class="muted">O e-mail ser√° enviado para: <b>pedro.fillype@energisa.com.br</b></p>
    </form>
  </div>

<script>
/* --------------------------
 CONFIG: EmailJS
---------------------------*/
const CONFIG = {
  EMAILJS_USER_ID: "DOOkPk4Rqm1NZhIWO",
  EMAILJS_SERVICE_ID: "service_915mowg",
  EMAILJS_TEMPLATE_ID: "template_lirn629",
  EMAIL_TO: "pedro.fillype@energisa.com.br"
};

function slugifyName(s) {
  return s.trim().replace(/\s+/g, "_").replace(/[^\w\-]/g, "");
}

/* --------------------------
  GEOLOCATION
---------------------------*/
document.getElementById("btnGeo").addEventListener("click", () => {
  if (!navigator.geolocation) { alert("Geolocaliza√ß√£o n√£o suportada."); return; }
  document.getElementById("btnGeo").innerText = "Capturando...";
  navigator.geolocation.getCurrentPosition((pos) => {
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    document.getElementById("geo").value = `${lat}, ${lng}`;
    document.getElementById("btnGeo").innerText = "Obter Localiza√ß√£o";
  });
});

/* --------------------------
  CSV
---------------------------*/
function gerarCSVString(obj) {
  const headers = ["timestamp","nome","regional","polo","matricula","datauso","tiporefeicao","horario","localidade","localizacao_gps","sequencia","osrrss","numeroadd","observacao"];
  const linha = [
    obj.timestamp,obj.nome,obj.regional,obj.polo,obj.matricula,obj.datauso,
    obj.tiporefeicao,obj.horario,obj.localidade,obj.localizacao_gps,obj.sequencia,
    obj.osrrss,obj.numeroadd,obj.observacao
  ];
  const q = v => `"${String(v).replace(/"/g,'""')}"`;
  return headers.map(q).join(",") + "\n" + linha.map(q).join(",");
}

function baixarCSV(csvString, filename) {
  const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  return url;
}

/* --------------------------
  E-MAIL via EmailJS
---------------------------*/
async function enviarEmailEmailJS(payload, csvString, csvUrl, csvFilename) {
  if (!window.emailjs) {
    await new Promise(res=>{
      const sc=document.createElement("script");
      sc.src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
      sc.onload=res;
      document.head.appendChild(sc);
    });
    emailjs.init(CONFIG.EMAILJS_USER_ID);
  }

  const plain = `
Nova presta√ß√£o de contas registrada:

Nome: ${payload.nome}
Regional: ${payload.regional}
Polo: ${payload.polo}
Matr√≠cula: ${payload.matricula}
Data do uso: ${payload.datauso}
Tipo de refei√ß√£o: ${payload.tiporefeicao}
Hor√°rio: ${payload.horario}
Localidade: ${payload.localidade}
Localiza√ß√£o GPS: ${payload.localizacao_gps}
Sequ√™ncia: ${payload.sequencia}
OS/RR/SS: ${payload.osrrss}
N√∫mero do ADD: ${payload.numeroadd}
Observa√ß√£o: ${payload.observacao}
Timestamp: ${payload.timestamp}
  `;

  const html = `
  <div style="font-family:Arial">
    <h2>Nova presta√ß√£o de contas - ADD</h2>
    <pre>${plain}</pre>
    <p>CSV gerado:</p>
    <pre>${csvString}</pre>
    <p>Download do CSV: <a href="${csvUrl}" target="_blank">${csvFilename}</a></p>
  </div>
  `;

  return emailjs.send(CONFIG.EMAILJS_SERVICE_ID, CONFIG.EMAILJS_TEMPLATE_ID, {
    to_email: CONFIG.EMAIL_TO,
    subject: `Presta√ß√£o ADD - ${payload.nome} - ${payload.datauso}`,
    plain_body: plain,
    html_body: html,
    csv_content: csvString,
    filename: csvFilename
  });
}

/* --------------------------
   SUBMIT
---------------------------*/
document.getElementById("addForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const btn = document.getElementById("btnSubmit");
  btn.disabled = true; btn.innerText = "Enviando...";

  const payload = {
    timestamp: new Date().toISOString(),
    nome: nome.value,
    regional: regional.value,
    polo: polo.value,
    matricula: matricula.value,
    datauso: datauso.value,
    tiporefeicao: tiporefeicao.value,
    horario: horario.value,
    localidade: localidade.value,
    localizacao_gps: geo.value,
    sequencia: sequencia.value,
    osrrss: osrrss.value,
    numeroadd: numeroadd.value,
    observacao: observacao.value
  };

  const csv = gerarCSVString(payload);

  const nomeSanit = slugifyName(payload.nome);
  const dataCurta = payload.timestamp.slice(0,10);
  const csvFilename = `prestacao_${nomeSanit}_${dataCurta}.csv`;

  const csvUrl = baixarCSV(csv, csvFilename);

  await enviarEmailEmailJS(payload, csv, csvUrl, csvFilename);

  alert("E-mail enviado com sucesso üëç");

  btn.disabled = false;
  btn.innerText = "Enviar (E-mail + CSV)";
});
</script>
</body>
</html>
