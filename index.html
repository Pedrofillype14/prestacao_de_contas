<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prestação de Contas - ADD</title>
<style>
  /* --- CORREÇÃO PRINCIPAL AQUI --- */
  * { box-sizing: border-box; } 

  body{font-family: "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg,#e3f2fd,#fff); padding:24px; color:#333; margin: 0;}
  .card{max-width:900px;margin:18px auto;padding:20px;border-radius:12px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
  h1{text-align:center;color:#0d47a1;margin:6px 0 12px;font-size:20px;text-transform:uppercase;}
  form{display:grid;gap:10px;}
  label{font-weight:600;font-size:14px; margin-bottom: 4px; display:block;}
  
  /* Ajuste no input para não estourar */
  input,select,textarea,button{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px solid #cfd8dc;
    background:#f7f9fc;
    font-size:15px;
    outline: none; /* remove borda azul padrão do chrome ao clicar */
  }
  
  input:focus, select:focus, textarea:focus {
    border-color: #1e88e5;
    background: #fff;
  }

  button{background:#1e88e5;color:#fff;border:none;cursor:pointer;font-weight:700; transition: background 0.3s;}
  button:hover{background:#1565c0;}
  
  .small{padding:8px;font-size:13px}
  .muted{color:#666;font-size:13px;text-align:center}

  /* === GRID DA LINHA === */
  .row {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Divide exatamente em 2 metades iguais */
    gap: 15px; /* Espaço seguro entre os inputs */
    margin-bottom: 2px;
  }

  /* Ajuste para celular */
  @media (max-width: 720px) {
    .row {
      grid-template-columns: 1fr; /* Vira 1 coluna no celular */
      gap: 10px;
    }
    body { padding: 12px; } /* Menos margem na borda do celular */
  }

  button.small { width: 100%; }
</style>
</head>
<body>
  <div class="card">
    <div style="text-align:center">
      
      <h1>PRESTAÇÃO DE CONTAS - ADD</h1>
    </div>

    <form id="addForm" autocomplete="off">
      <div>
        <label>Nome *</label>
        <input id="nome" type="text" required>
      </div>

      <div class="row">
        <div>
           <label>Regional *</label>
           <select id="regional" required>
             <option value="">Selecione...</option><option>LESTE</option><option>CENTRO</option><option>OESTE</option>
           </select>
        </div>
        <div>
           <label>Polo *</label>
           <select id="polo" required>
             <option value="">Selecione...</option>
             <option>João Pessoa</option><option>Itabaiana</option><option>Mamanguape</option><option>Borborema</option>
             <option>Campina Grande</option><option>Monteiro</option><option>Guarabira</option><option>Esperança</option>
             <option>Itaporanga</option><option>Sousa</option><option>Patos</option><option>Catolé do Rocha</option>
           </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Matrícula *</label>
          <input id="matricula" type="text" required>
        </div>
        <div>
          <label>Data do uso *</label>
          <input id="datauso" type="date" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Tipo de Refeição *</label>
          <select id="tiporefeicao" required>
            <option value="">Selecione...</option>
            <option>ALMOÇO</option><option>JANTA</option><option>EXTRA (APÓS DUAS HORAS DO FINAL DA ESCALA)</option>
          </select>
        </div>
        <div>
          <label>Horário *</label>
          <input id="horario" type="time" required>
        </div>
      </div>

      <div>
        <label>Localidade em que foi usado o ADD *</label>
        <input id="localidade" type="text" required>
      </div>

      <div class="row">
        <div>
          <label>Solicitar localização geográfica *</label>
          <button type="button" id="btnGeo" class="small">Obter Localização</button>
        </div>
        <div>
          <label>Coordenadas *</label>
          <input id="geo" type="text" placeholder="lat, lng" readonly required>
        </div>
      </div>

      <div>
        <label>Sequência do ADD (opcional)</label>
        <input id="sequencia" type="text" placeholder="Ex: 1°, 2°, 3°">
      </div>

      <div class="row">
        <div>
          <label>Número da OS / RR / SS (opcional)</label>
          <input id="osrrss" type="text">
        </div>
        <div>
          <label>Número do ADD (opcional)</label>
          <input id="numeroadd" type="text">
        </div>
      </div>

      <div>
        <label>Observação sobre a refeição (opcional)</label>
        <textarea id="observacao" rows="3"></textarea>
      </div>

      <button id="btnSubmit" type="submit" style="margin-top:10px">Enviar (E-mail + CSV)</button>
      <p class="muted">O e-mail será enviado para: <b>pedro.fillype@energisa.com.br</b></p>
    </form>
  </div>

<script>
/* --------------------------
 CONFIG: EmailJS
---------------------------*/
const CONFIG = {
  EMAILJS_USER_ID: "DOOkPk4Rqm1NZhIWO",
  EMAILJS_SERVICE_ID: "service_915mowg",
  EMAILJS_TEMPLATE_ID: "template_lirn629",
  EMAIL_TO: "pedro.fillype@energisa.com.br"
};

function slugifyName(s) {
  return String(s||"").trim().replace(/\s+/g, "_").replace(/[^\w\-]/g, "");
}

/* wait DOM */
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("addForm");
  const btnGeo = document.getElementById("btnGeo");
  const btnSubmit = document.getElementById("btnSubmit");

  const nome = document.getElementById("nome");
  const regional = document.getElementById("regional");
  const polo = document.getElementById("polo");
  const matricula = document.getElementById("matricula");
  const datauso = document.getElementById("datauso");
  const tiporefeicao = document.getElementById("tiporefeicao");
  const horario = document.getElementById("horario");
  const localidade = document.getElementById("localidade");
  const geo = document.getElementById("geo");
  const sequencia = document.getElementById("sequencia");
  const osrrss = document.getElementById("osrrss");
  const numeroadd = document.getElementById("numeroadd");
  const observacao = document.getElementById("observacao");

  /* GEOLOCATION */
  btnGeo.addEventListener("click", () => {
    if (!navigator.geolocation) { alert("Geolocalização não suportada."); return; }
    btnGeo.innerText = "Capturando...";
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      geo.value = `${lat}, ${lng}`;
      btnGeo.innerText = "Localização OK!";
      btnGeo.style.background = "#43a047";
    }, (err)=>{
      console.error(err);
      alert("Ative o GPS e tente novamente.");
      btnGeo.innerText = "Obter Localização";
    }, {enableHighAccuracy:true, timeout:10000});
  });

  /* CSV helpers com fix UTF-8 BOM */
  function gerarCSVString(obj) {
    const headers = ["timestamp","nome","regional","polo","matricula","datauso","tiporefeicao","horario","localidade","localizacao_gps","sequencia","osrrss","numeroadd","observacao"];
    const linha = [
      obj.timestamp,obj.nome,obj.regional,obj.polo,obj.matricula,obj.datauso,
      obj.tiporefeicao,obj.horario,obj.localidade,obj.localizacao_gps,obj.sequencia,
      obj.osrrss,obj.numeroadd,obj.observacao
    ];
    const q = v => `"${String(v === undefined || v === null ? "" : v).replace(/"/g,'""')}"`;
    return headers.map(q).join(",") + "\n" + linha.map(q).join(",");
  }

  function baixarCSV(csvString, filename) {
    // Adicionado \uFEFF para o Excel abrir acentos corretamente
    const blob = new Blob(["\uFEFF" + csvString], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    return url;
  }

  /* EmailJS loader */
  let emailjsReady = false;
  async function ensureEmailJS() {
    if (emailjsReady && window.emailjs) return;
    if (!window.emailjs) {
      await new Promise(res=>{
        const sc=document.createElement("script");
        sc.src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
        sc.onload = res;
        sc.onerror = ()=>{ res(); console.warn("Falha ao carregar EmailJS"); };
        document.head.appendChild(sc);
      });
    }
    if (window.emailjs && !emailjsReady) {
      try { emailjs.init(CONFIG.EMAILJS_USER_ID); } catch(e) { console.warn("emailjs.init falhou:", e); }
      emailjsReady = true;
    }
  }

  async function enviarEmailEmailJS(payload, csvString, csvUrl, csvFilename) {
    await ensureEmailJS();
    if (!window.emailjs) throw new Error("EmailJS não carregado");

    const plain = `
NOVA PRESTAÇÃO - ADD
--------------------
Nome: ${payload.nome}
Matrícula: ${payload.matricula}
Data: ${payload.datauso}
Regional: ${payload.regional} | Polo: ${payload.polo}
Refeição: ${payload.tiporefeicao} (${payload.horario})
Local: ${payload.localidade}
GPS: ${payload.localizacao_gps}
OS/RR/SS: ${payload.osrrss}
Nº ADD: ${payload.numeroadd}
Obs: ${payload.observacao}
    `;

    return emailjs.send(CONFIG.EMAILJS_SERVICE_ID, CONFIG.EMAILJS_TEMPLATE_ID, {
      to_email: CONFIG.EMAIL_TO,
      subject: `ADD - ${payload.nome} - ${payload.datauso}`,
      plain_body: plain,
      csv_content: csvString,
      filename: csvFilename
    });
  }

  /* FORM submit */
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    btnSubmit.disabled = true;
    btnSubmit.innerText = "Processando...";

    try {
      const payload = {
        timestamp: new Date().toISOString(),
        nome: nome.value.trim(),
        regional: regional.value,
        polo: polo.value,
        matricula: matricula.value.trim(),
        datauso: datauso.value,
        tiporefeicao: tiporefeicao.value,
        horario: horario.value,
        localidade: localidade.value.trim(),
        localizacao_gps: geo.value,
        sequencia: sequencia.value.trim(),
        osrrss: osrrss.value.trim(),
        numeroadd: numeroadd.value.trim(),
        observacao: observacao.value.trim()
      };

      const csv = gerarCSVString(payload);
      const nomeSanit = slugifyName(payload.nome || "func");
      const dataCurta = payload.timestamp.slice(0,10);
      const csvFilename = `ADD_${nomeSanit}_${dataCurta}.csv`;

      // 1. Baixar CSV (Garantia)
      const csvUrl = baixarCSV(csv, csvFilename);

      // 2. Tentar Email
      btnSubmit.innerText = "Enviando E-mail...";
      try {
        await enviarEmailEmailJS(payload, csv, csvUrl, csvFilename);
        alert("Sucesso! E-mail enviado e arquivo salvo.");
      } catch (err) {
        console.error(err);
        alert("Atenção: O CSV foi baixado no seu dispositivo, mas houve erro ao enviar o e-mail automático.");
      }

      setTimeout(()=> { try { URL.revokeObjectURL(csvUrl); } catch(e){} }, 8000);
      form.reset();
      btnGeo.innerText = "Obter Localização";
      btnGeo.style.background = "#1e88e5";

    } catch (err) {
      console.error(err);
      alert("Erro fatal no formulário.");
    } finally {
      btnSubmit.disabled = false;
      btnSubmit.innerText = "Enviar (E-mail + CSV)";
    }
  });
});
</script>
</body>
</html>
