<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Presta√ß√£o de Contas - ADD</title>

<style>
  :root {
    --energisa-blue: #0097CE;
    --energisa-blue-dark: #0079a6;
    --energisa-orange: #F36F21;
    --bg-soft: #f4f9fc;
    --text-dark: #333;
  }

  * { box-sizing: border-box; }
  body {
    font-family: "Segoe UI", Roboto, sans-serif;
    background: var(--bg-soft);
    padding: 24px;
    color: var(--text-dark);
    margin: 0;
  }

  /* Card */
  .card {
    max-width: 900px;
    margin: 24px auto;
    padding: 28px;
    border-radius: 14px;
    background: #fff;
    box-shadow: 0 6px 26px rgba(0,0,0,0.10);
    border-top: 6px solid var(--energisa-orange);
  }

  /* T√≠tulo */
  h1 {
    text-align: center;
    color: var(--energisa-blue);
    margin: 6px 0 20px;
    font-size: 26px;
    font-weight: 800;
    letter-spacing: 1px;
  }

  /* Form */
  form { display: grid; gap: 14px; }

  label {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
    display: block;
  }

  input, select, textarea {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #cfd8dc;
    background: #fbfcff;
    font-size: 15px;
    outline: none;
    transition: 0.2s;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--energisa-blue);
    background: #fff;
    box-shadow: 0 0 0 2px rgba(0,151,206,0.20);
  }

  /* Button */
  button {
    background: var(--energisa-blue);
    color: #fff;
    border: none;
    padding: 14px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 700;
    border-radius: 10px;
    transition: 0.3s;
  }
  button:hover {
    background: var(--energisa-blue-dark);
  }

  /* Bot√£o pequeno */
  .small {
    padding: 10px;
    font-size: 13px;
    background: var(--energisa-orange);
  }
  .small:hover {
    background: #d85e1c;
  }

  /* Grid responsivo */
  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  @media(max-width: 720px) {
    .row { grid-template-columns: 1fr; }
    body { padding: 14px; }
  }

  .muted {
    color: #666;
    font-size: 13px;
    text-align: center;
    margin-top: 6px;
  }
</style>
</head>
<body>

<div class="card">
  <h1>PRESTA√á√ÉO DE CONTAS - ADD</h1>

  <form id="addForm" autocomplete="off">

    <div>
      <label>Nome *</label>
      <input id="nome" name="nome" type="text" required>
    </div>

    <div>
      <label>Email *</label>
      <input id="email" name="email" type="text" required>
    </div>

    <div class="row">
      <div>
        <label>Regional *</label>
        <select id="regional" name="regional" required>
          <option value="">Selecione...</option>
          <option>LESTE</option><option>CENTRO</option><option>OESTE</option>
        </select>
      </div>

      <div>
        <label>Polo *</label>
        <select id="polo" name="polo" required>
          <option value="">Selecione...</option>
          <option>Jo√£o Pessoa</option><option>Itabaiana</option><option>Mamanguape</option>
          <option>Borborema</option><option>Campina Grande</option><option>Monteiro</option>
          <option>Guarabira</option><option>Esperan√ßa</option><option>Itaporanga</option>
          <option>Sousa</option><option>Patos</option><option>Catol√© do Rocha</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Matr√≠cula *</label>
        <input id="matricula" name="matricula" type="text" required>
      </div>

      <div>
        <label>Data do uso *</label>
        <input id="datauso" name="datauso" type="date" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Tipo de Refei√ß√£o *</label>
        <select id="tiporefeicao" name="tiporefeicao" required>
          <option value="">Selecione...</option>
          <option>ALMO√áO</option><option>JANTA</option>
          <option>EXTRA</option>
        </select>
      </div>

      <div>
        <label>Hor√°rio *</label>
        <input id="horario" name="horario" type="time" required>
      </div>
    </div>

    <div>
      <label>Localidade *</label>
      <input id="localidade" name="localidade" type="text" required>
    </div>

    <div class="row">
      <div>
        <label>Solicitar Localiza√ß√£o *</label>
        <button type="button" id="btnGeo" class="small">Obter Localiza√ß√£o</button>
      </div>

      <div>
        <label>Coordenadas *</label>
        <input id="geo" name="localizacao_gps" type="text" placeholder="lat, lng" readonly required>
      </div>
    </div>

    <div>
      <label>Sequ√™ncia do ADD (opcional)</label>
      <input id="sequencia" name="sequencia" type="text">
    </div>

    <div class="row">
      <div>
        <label>N√∫mero da OS / RR / SS (opcional)</label>
        <input id="osrrss" name="osrrss" type="text">
      </div>

      <div>
        <label>N√∫mero do ADD (opcional)</label>
        <input id="numeroadd" name="numeroadd" type="text">
      </div>
    </div>

    <div>
      <label>Observa√ß√£o (opcional)</label>
      <textarea id="observacao" name="observacao" rows="3"></textarea>
    </div>
    
    <button id="btnSubmit" type="submit">Enviar (E-mail)</button>

    <!-- üîó LINK PARA O DASHBOARD (AGORA NA MESMA ABA) -->
    <a href="https://pedrofillype14.github.io/prestacao_dashboard/" 
       style="display:block; text-align:center; margin-top:16px; 
              background: var(--energisa-blue); color:white;
              padding:12px; border-radius:10px; font-weight:700;
              text-decoration:none; transition:0.3s;">
        üîç Acessar Dashboard / Consulta de Registros
    </a>

    <p class="muted">Desenvolvido por Pedro Fillype (Analista Grupo Energisa).</p>
  </form>
</div>



  <script>
/* --- NOVO BLOCO: PEGAR MATR√çCULA DO LOGIN --- */
document.addEventListener("DOMContentLoaded", () => {
    const matricula = document.getElementById("matricula");

    // Pega matr√≠cula do localStorage
    const usuarioLogado = localStorage.getItem("usuarioLogado");

    if (!usuarioLogado) {
        alert("Voc√™ precisa fazer login antes de acessar o formul√°rio.");
        window.location.href = "https://pedrofillype14.github.io/login/";
        return;
    }

    // Preenche e bloqueia
    matricula.value = usuarioLogado;
    matricula.readOnly = true;
    matricula.style.background = "#e9ecef";
    matricula.style.cursor = "not-allowed";
});

/* --- JS MANTIDO E MELHORADO VISUALMENTE --- */
document.addEventListener("DOMContentLoaded", ()=>{

  const form = document.getElementById("addForm");
  const btnGeo = document.getElementById("btnGeo");
  const btnSubmit = document.getElementById("btnSubmit");

  const nome = document.getElementById("nome");
  const email = document.getElementById("email");
  const regional = document.getElementById("regional");
  const polo = document.getElementById("polo");
  const matricula = document.getElementById("matricula");
  const datauso = document.getElementById("datauso");
  const tiporefeicao = document.getElementById("tiporefeicao");
  const horario = document.getElementById("horario");
  const localidade = document.getElementById("localidade");
  const geo = document.getElementById("geo");
  const sequencia = document.getElementById("sequencia");
  const osrrss = document.getElementById("osrrss");
  const numeroadd = document.getElementById("numeroadd");
  const observacao = document.getElementById("observacao");

  
  btnGeo.addEventListener("click", ()=>{
    if(!navigator.geolocation){ alert("Geolocaliza√ß√£o n√£o suportada."); return; }
    btnGeo.innerText="Capturando...";
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      geo.value = `${lat}, ${lng}`;
      btnGeo.innerText="Localiza√ß√£o OK!";
      btnGeo.style.background="#43a047";
    },(err)=>{
      console.error("geolocation error:", err);
      alert("Ative o GPS e tente novamente.");
      btnGeo.innerText="Obter Localiza√ß√£o";
    },{enableHighAccuracy:true,timeout:10000});
  });


  function gerarCSV(obj){
    const headers = Object.keys(obj);
    const values  = Object.values(obj);
    const q = v=>`"${String(v??"").replace(/"/g,'""')}"`;
    return headers.map(q).join(",") + "\n" + values.map(q).join(",");
  }


  form.addEventListener("submit", async e=>{
    e.preventDefault();
    btnSubmit.disabled=true;
    btnSubmit.innerText="Enviando...";

    try{
      const payload = {
        nome: nome.value.trim(),
        email: email.value.trim(),
        regional: regional.value,
        polo: polo.value,
        matricula: matricula.value.trim(),
        datauso: datauso.value,
        tiporefeicao: tiporefeicao.value,
        horario: horario.value,
        localidade: localidade.value.trim(),
        gps: geo.value,
        sequencia: sequencia.value.trim(),
        osrrss: osrrss.value.trim(),
        numeroadd: numeroadd.value.trim(),
        observacao: observacao.value.trim()
      };

      const csv = gerarCSV(payload);
      const csvFilename = `ADD_${payload.nome.replace(/\s+/g,"_")}_${(new Date()).toISOString().slice(0,10)}.csv`;
      const csvBlob = new Blob([csv], { type: "text/csv" });

      const fd = new FormData();
      Object.entries(payload).forEach(([k,v]) => fd.append(k, v ?? ""));
      fd.append("arquivo", new File([csvBlob], csvFilename, { type: "text/csv" }));

      const workerUrl = "https://long-hall-0aaa.pedro-fillype.workers.dev/submit";

      const resp = await fetch(workerUrl, { method:"POST", body: fd });
      const txt = await resp.text();

      let parsed;
      try { parsed = JSON.parse(txt); } catch { parsed = null; }

      if (!resp.ok) {
        alert("Erro no servidor: " + (parsed?.error || parsed?.message || txt));
      } else {
        alert("Enviado com sucesso!");
        form.reset();
        btnGeo.innerText="Obter Localiza√ß√£o";
        btnGeo.style.background="var(--energisa-orange)";
      }

    } catch (err) {
      alert("Erro inesperado: " + err.message);
    }

    btnSubmit.disabled=false;
    btnSubmit.innerText="Enviar (E-mail + CSV)";
  });

});
</script>

</body>
</html>
